dependencies:
  pre:
    - gem install package_cloud
    - gem install fpm
    - sudo apt-get install rpm
    - go get github.com/jteeuwen/go-bindata/...
test:
  override:
    - go test -v -race $(go list ./... | grep -v /vendor/)
  post:
    - make packages # note, this runs go-bindata again
    # ideally we'd make sure that if go-bindata generated new content, we fail.
    # because devs should have run go-bindata and checked in changes already.
    # but because git checkout will change the timestamps and mode, it'll generate slight differences, and it's hard to filter those out
    # so for now, we just let it slip and assume devs will do a good enough job maintaining the generated data
    # - git diff --exit-code
general:
  artifacts:
    - build
deployment:
  production:
    branch: master
    commands:
      # Ubuntu 14.04 (trusty), 16.04 (xenial), debian 8 (jessie), Centos6 and Centos7. (no debian 7 wheezy because that's sysvinit which we don't have packages for)
      - package_cloud push ${PACKAGECLOUD_REPO}/ubuntu/trusty build/deb-upstart/carbon-relay-ng-*.deb
      - package_cloud push ${PACKAGECLOUD_REPO}/ubuntu/xenial build/deb-systemd/carbon-relay-ng-*.deb
      - package_cloud push ${PACKAGECLOUD_REPO}/debian/jessie build/deb-systemd/carbon-relay-ng-*.deb
      - package_cloud push ${PACKAGECLOUD_REPO}/el/6          build/centos-6/carbon-relay-ng-*.el6.*.rpm
      - package_cloud push ${PACKAGECLOUD_REPO}/el/7          build/centos-7/carbon-relay-ng-*.el7.*.rpm
